pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = credentials('docker-hub-credentials')
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ó–ê–ú–ï–ù–ò 'TVOI-DOCKERHUB-LOGIN' –Ω–∞ —Å–≤–æ–π –ª–æ–≥–∏–Ω Docker Hub! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        DOCKER_IMAGE_BACKEND = 'himatora/tutor-control-backend'
        DOCKER_IMAGE_FRONTEND = 'himatora/tutor-control-frontend'
        DOCKER_TAG = "build-${BUILD_NUMBER}"
        
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ó–ê–ú–ï–ù–ò '/home/user/tutor-ontrol' –Ω–∞ —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        TARGET_DIR = '/mnt/c/Users/User/Desktop/2lab/tutor-ontrol'
        GIT_REPO_URL = 'https://github.com/Himatora/tutor-ontrol.git'
    }

    triggers { 
        githubPush() 
    }

    stages {
        stage('Clean Workspace and Setup') {
            steps {
                sh """
                    echo "–û—á–∏—â–∞–µ–º —Ä–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ..."
                    cd "${TARGET_DIR}"
                    
                    echo "–¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞:"
                    pwd
                    
                    echo "–°—Ç–∞—Ç—É—Å Git:"
                    git status || echo "Git –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
                    
                    echo "Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–æ –∑–∞–ø—É—Å–∫–∞:"
                    docker ps -a || echo "Docker –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
                    
                    echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
                    docker-compose down || echo "–ù–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
                    
                    echo "=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –í–ï–¢–ö–ï ==="
                    git branch --show-current
                    git log -1 --oneline
                """
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    echo "üõ† –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ –±—ç–∫–µ–Ω–¥–∞..."
                    dir('backend') {
                        docker.build("${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}")
                    }
                    
                    echo "üõ† –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
                    dir('frontend') {
                        docker.build("${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}")
                    }
                }
            }
        }

        stage('Start Backend Server') {
            steps {
                sh """
                    cd "${TARGET_DIR}"
                    echo "–ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫–µ–Ω–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
                    docker-compose up -d backend
                    
                    echo "–ñ–¥—ë–º 10 —Å–µ–∫—É–Ω–¥ –ø–æ–∫–∞ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è..."
                    sleep 10
                    
                    echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
                    docker ps
                """
            }
        }

        stage('Start Frontend Server') {
            steps {
                sh """
                    cd "${TARGET_DIR}"
                    echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
                    docker-compose up -d frontend
                    
                    echo "–§—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ Docker"
                    docker ps
                """
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    try {
                        echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã Django –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ..."
                        sh """
                            cd "${TARGET_DIR}"
                            docker-compose exec -T backend python manage.py test --verbosity=2
                        """
                        echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏! –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å."
                    } catch (err) {
                        echo "‚ùå –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
                        sh """
                            cd "${TARGET_DIR}"
                            docker-compose down
                        """
                        error("–¢–µ—Å—Ç—ã Django –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.")
                    }
                }
            }
        }

        stage('Push Images to Docker Hub') {
            when { 
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' } 
            }
            steps {
                script {
                    echo "üì¶ –ü—É–±–ª–∏–∫—É–µ–º –æ–±—Ä–∞–∑—ã –≤ Docker Hub..."
                    docker.withRegistry('', DOCKERHUB_CREDENTIALS) {
                        docker.image("${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}").push()
                        docker.image("${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}").push()
                        docker.image("${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG}").push('latest')
                        docker.image("${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG}").push('latest')
                    }
                }
            }
        }

        stage('Merge fix into master and deploy') {
            when { 
                expression { 
                    (env.BRANCH_NAME?.contains('fix') || env.GIT_BRANCH?.contains('fix')) && 
                    (currentBuild.result == null || currentBuild.result == 'SUCCESS')
                } 
            }
            steps {
                script {
                    echo "üîÑ –ú–µ—Ä–∂–∏–º –≤–µ—Ç–∫—É fix –≤ master –∏ –¥–µ–ø–ª–æ–∏–º..."
                    
                    withCredentials([
                        usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN'),
                        string(credentialsId: 'github-email', variable: 'GIT_EMAIL')
                    ]) {
                        sh """
                            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git
                            git config --global --add safe.directory "${TARGET_DIR}"
                            git config user.name "${GIT_USER}"
                            git config user.email "${GIT_EMAIL}"

                            # –ú–µ—Ä–∂ fix –≤ master
                            git checkout master
                            git pull https://${GIT_USER}:${GIT_TOKEN}@github.com/Himatora/tutor-ontrol.git master
                            git merge origin/fix --no-ff
                            git push https://${GIT_USER}:${GIT_TOKEN}@github.com/Himatora/tutor-ontrol.git master

                            git checkout fix
                            git reset --hard master
                            git push --force https://${GIT_USER}:${GIT_TOKEN}@github.com/Himatora/tutor-ontrol.git fix

                            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ master –¥–ª—è –¥–µ–ø–ª–æ—è
                            git checkout master
                        """
                    }

                    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º –∫–æ–¥–æ–º
                    echo "üöÄ –î–µ–ø–ª–æ–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π master..."
                    sh """
                        cd "${TARGET_DIR}"
                        docker-compose down
                        docker-compose up -d
                    """

                    echo "‚úÖ –í–µ—Ç–∫–∞ fix –≤–º–µ—Ä–∂–µ–Ω–∞ –≤ master –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞!"
                }
            }
        }
    }

    post {
        always {
            echo "üßπ –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã..."
            sh """
                docker rmi ${DOCKER_IMAGE_BACKEND}:${DOCKER_TAG} || echo "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –±—ç–∫–µ–Ω–¥ –æ–±—Ä–∞–∑"
                docker rmi ${DOCKER_IMAGE_FRONTEND}:${DOCKER_TAG} || echo "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ–±—Ä–∞–∑"
            """
        }
        success {
            echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω! –ë—ç–∫–µ–Ω–¥ –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ Docker"
            echo "üìç –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://localhost/"
            echo "üìç –ë—ç–∫–µ–Ω–¥: http://localhost:8000/"
            echo "üìç –ê–¥–º–∏–Ω–∫–∞: http://localhost:8000/admin/"
        }
    }
}